# 配置小记

## 多页面配置

实现多页面配置需要修改的地方：

- 入口配置

- 模板插件 `HtmlWebpackPlugin`

- 自定义服务启动

- 实现页面自动更新

**入口配置**

假设当前的页面目录

```js
- src
  - views
     - page1
       - index.js
     - page1
       - index.js
```

规定 `/src/views` 下的目录代表一个页面，需要在 Webpack `entry` 属配置多入口：

```js
entry: {
    page1: './src/views/page1/index.js',
    page2: './src/views/page2/index.js'
}
```

下面是自动根据目录添加 `entry` 配置的辅助方法：

```js
const glob = require("glob");

function multyEntry() {
    const entry = {};
    //读取src目录所有page入口
    glob.sync('./src/views/*/index.js')
        .forEach(function (filePath) {
            console.log('filePath', filePath)
            var name = filePath.match(/\/src\/views\/(.+)\/index.js/);
            name = name[1];
            entry[name] = [filePath, 'webpack-hot-middleware/client?reload=true'];
        });
    console.log('entry', entry)
    return entry;
};

{
    entry: multyEntry()
}
```

**模板插件 `HtmlWebpackPlugin`**

跟入口文件一样，一个页面需要添加一个 `HtmlWebpackPlugin`, 那么怎么跟入口文件对应呢？ 通过 `chunt`。`chunt` 就是上面例子的 `entry` 的 `key` : `page1`和 `page2`

```js
function multyHtmlWebpackPlugin(){
    const htmlPlugin = [];
    glob.sync('./src/views/*/index.js')
        .forEach(function (filePath) {
            var name = filePath.match(/\/src\/views\/(.+)\/index.js/);
            name = name[1];
            htmlPlugin.push(
                new HtmlWebpackPlugin({
                    title: 'Output Management',
                    filename: './' + name + '/index.html',
                    template: './index.html',
                    inject: true,
                    chunks: [name]
                    
                })
            )
        });
    return htmlPlugin;
}
```

**自定义服务启动**

Webpack 本质是通过 `Webpack-dev-server` 来启动服务的，配置多页面多后如果直接使用 `Webpack-dev-server` ，在访问页面的时候需要输入完整的页面地址才能访问，比如上便中的 `page1`， 我们需要输入 `localhost:8080/page1.html`。

```js
// dev-server.js
var express = require('express')
var webpack = require('webpack')
var path = require('path')
var webpackHotMiddleware = require('webpack-hot-middleware')
var WebpackDevMiddleware = require('webpack-dev-middleware')
var multyWebpack = require('./webpack.multy')
var webpackConfig = multyWebpack(require('./webpack.config')({}))
var app = express();
// webpack编译器
var compiler = webpack(webpackConfig);
// return
// webpack-dev-server中间件
var devMiddleware = WebpackDevMiddleware(compiler, {
    publicPath: '/',
    // publicPath: webpackConfig.output.publicPath,
    stats: {
        colors: true,
        chunks: false
    },
    progress: true,
    inline: true,
    hot: true
});

app.use(devMiddleware)
app.use(webpackHotMiddleware(compiler))

// 路由
app.get('/:viewname?', function(req, res, next) {
    var viewname = req.params.viewname 
        ? req.params.viewname + '.html' 
        : 'index.html';

    var filepath = path.join(compiler.outputPath, viewname);

    // 使用webpack提供的outputFileSystem
    compiler.outputFileSystem.readFile(filepath, function(err, result) {
        if (err) {
            // something error
            return next(err);
        }
        res.set('content-type', 'text/html');
        res.send(result);
        res.end();
    });
});
app.use(express.static(path.join(__dirname, '../')));
module.exports = app.listen(8080, function(err) {
    if (err) {
        // do something
        return;
    }
    console.log('Listening at http://localhost:' + '8000' + '\n')
})
```

https://godbasin.github.io/2017/08/19/webpack-multi-project-6-hot-reload/

https://imweb.io/topic/5d1091abf7b5692b080f25a4