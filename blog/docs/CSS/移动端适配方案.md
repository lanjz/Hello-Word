# 移动端适配方案

先理解几个概念

## 视口 viewport

`viewport` 解释为中文就是‘视口’的意思，也就是浏览器中用于显示网页的区域。在 PC 端，其大小也就是浏览器可视区域的大小，所以我们也不会太关注此概念；而在移动端，绝大多数情况下 `viewport` 都大于浏览器可视区，以保证 PC 页面在移动浏览器上面的可视性。

这里以 iphone6/7/8 为例：

![](./static/view_1.png)

这里我们会看到，明明屏幕的宽度只有 `375px`，可是 `body` 的宽度却是 `980px`，那么这个 `980px` 到底是从哪里来的呢？

其实，这里的 `980px` 就是移动端所谓的布局视口了

为了显示出屏幕的真正尺寸，苹果引入了理想视口的概念，它是对设备来说最理想的布局视口尺寸，所以就有以下代码

```html
<meta name ="viewport" content="width=device-width">
```

添加以上代码后，我们重新刷新页面就可以看到屏幕的尺寸变为了 `375 * 667` 与屏幕一致了

然而，这段代码其实也并不完美，在 IE 浏览器中，由于横屏竖屏的切换会对其造成影响，为了解决这个兼容性的问题，最后再加上一句，就有了以下代码：

```html
<meta name='viewport' content='width=device-width,initial-scale=1,user-scale=no' />
```

`initial-scale=1` 的意思是初始缩放的比例是 `1`，使用它的时候，同时也会将布局视口的尺寸设置为缩放后的尺寸。而缩放的尺寸就是基于屏幕的宽度来的

## 设备像素比 dpr

**物理像素（physical pixel）**

手机屏幕上显示的最小单元，该最小单元具有颜色及亮度的属性可供设置，iphone6、7、8 为：`750 * 1334`，iphone6+、7+、8+ 为 `1242 * 2208`

**设备独立像素（density-indenpendent pixel）**

此为逻辑像素，计算机设备中的一个点，css 中设置的像素指的就是该像素。老早在没有 retina 屏之前，设备独立像素与物理像素是相等的。

**设备像素比（device pixel ratio）**

设备像素比(dpr) = 物理像素/设备独立像素。如 iphone 6、7、8 的 `dpr` 为 `2`，那么一个设备独立像素便为 `4` 个物理像素，因此在 css 上设置的 `1px` 在其屏幕上占据的是 `2` 个物理像素，这就是 `1px` 的线条在 retina 屏上变粗的原因

## 移动端适配方案

目前通常使用 `flexible` 配合 `rem` 来做移动端的样式适配

`rem` 是相对于根元素 `html` 的 `font-size` 来做计算得到最终 `px` 值的

```html
html{
    font-size: 100px
}
.app{
    font-size: .5rem // 等于50px
}
```

### flexible 的原理

**首先设置 `viewport`**

```js
if (!dpr && !scale) {
    var isAndroid = win.navigator.appVersion.match(/android/gi);
    var isIPhone = win.navigator.appVersion.match(/iphone/gi);
    var devicePixelRatio = win.devicePixelRatio;
    if (isIPhone) {
        // iOS下，对于2和3的屏，用2倍的方案，其余的用1倍方案
        if (devicePixelRatio >= 3 && (!dpr || dpr >= 3)) {
            dpr = 3;
        } else if (devicePixelRatio >= 2 && (!dpr || dpr >= 2)){
            dpr = 2;
        } else {
            dpr = 1;
        }
    } else {
        // 其他设备下，仍旧使用1倍的方案
        dpr = 1;
    }
    scale = 1 / dpr;
}
```

在 iphone 下直接根据 `devicePixelRatio` 的值得到页面的缩放比

**设置 html 的 `font-size`**

```js
 function refreshRem(){
    var width = docEl.getBoundingClientRect().width;
    if (width / dpr > 540) {
        width = 540 * dpr;
    }
    var rem = width / 10;
    docEl.style.fontSize = rem + 'px';
    flexible.rem = win.rem = rem;
}
```

正常情况下根据 `可视宽度/10` 的计算结果作为根元素 `font-size` 的值

## 项目设置 rem

在项目中通过使用 `px2rem-loader` 来自己对我们的单位做转换

```js
{
    test: /\.(css|less)$/,
    use: [
        'css-loader',
        'postcss-loader',
        {
            loader: 'px2rem-loader',
            options: {
                remUnit: 75,
                remPrecision: 8
            }
        },
        'less-loader'
    ],
},
```

使用 `px2rem-loader` 要注意的点是它也会把我们引用第三UI库的样式给转换了，为了避免这种情况，我们可以利用 `include`，`exclude` 排除 `loader`的作用范围

[深入浅出移动端适配（总结版）](https://juejin.im/post/5d87518f6fb9a06aed715ecf#heading-23)