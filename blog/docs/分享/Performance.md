# Performance

## 我们为什么要做前端性能优化

在我们的开发生涯中，”性能“ 和 ”体验“ 这两个词一直都没有离开过。 这两个词有时候更像是一种 “无形的需求”，平时的在开发过程总是不可避免需要去思考怎样的代码设计才能达到最佳性能体验

那么性能到底有重要？

性能优化有多重要？这里先举个性能与转化率的关系来说明性能的重要性

如果用户执行了网页设计师希望他们执行的操作，这便发生了转化

那么转化率就是 发生转化的数量 / 总访问量

比如我们开发一个电商网站，现在一共有 100 个用户访问了商品，而其中有 2 个用户点击中 “购买” 按钮，那么转化率真就是 2%

相同的流量下，肯定是希望转换率越高越好，那么影响用户点击购买按钮的因素 除了商品本身外，页面的性能其实也是其中一个重要因素

这些我在网搜集到一些资料数据

比如  AI 医疗保健软件公司 mPulse (m'pʌls  么 pose) Mobile 的测试发现：

页面加载时间为 2.4 秒以内时，其转化率为 1.9％
3.3 秒时，转化率为 1.5％
4.2 秒时，转化率为不到 1.1％
超过 5.7 秒时，转化率为 0.6％

沃尔玛发现，页面加载时间每减少 1 秒，转化数就会增加 2％

COOK 通过将页面加载时间减少 0.85 秒，使转化数提高了 7％

Mobify（么比 fy）(移动通讯公司) 发现，首页加载时间每减少 100 毫秒，转化率就会提高 1.11％

除了转化率，网站速度也影响跳出率

47% 的客户希望网页在 2 秒或更短时间内完成加载

BBC发现，其网站加载时间每增加一秒，就会多流失10%的用户

这些例子都表明了  性能的重要性，以及我们做性能优化的必要性，这些是开发过程中不可忽视的一个工作环节，

那么为了更好做性能优化工作，前提就得懂得如果发现和发现性能问题

Performance 就是这么一个能够帮助我们定位问题的工具

## Performance

Performance 是 谷歌浏览内置集成的一个工具，它是性能分析和优化的利器，因为它可以记录每一段代码的耗时，进而分析出性能瓶颈

使用的也很简单

进入Performance 工具后，点击左上角的 圆圈按钮，然后在页面上进行一些操作，然后就点击 stop 按钮，就可以生成一份性能报告了

在录制的过程中，不建议进行太多的操作，输出的报表操作范围太多的话，分析起来也麻烦

这是一个报告的样子，可以发现其中划分很好几块的面板区域，接下就先了解下各面板代表什么

### 整体概览

这里主要是展示了整体的渲染的情况，这部分包含了五个信息： FPS、CPU、NET、屏幕快照、HEAP 的运行情况

屏幕快照就是某一时刻的界面渲染结果，只需要鼠标放上去可以看到了，其实四个我们也得了解一下

### FPS

首先是 FPS 也叫 刷新率，也就是上面这一条线

FPS 表示的是页面每秒的刷新频率. FPS 好坏衡量标准：  
fps = 60: 则表示性能极佳  
当 fps < 24 时: 就会让用户感觉到明显卡顿，因为人眼的识别主要是24帧

所以为了让帧率尽可能保持在 60 帧率，意味着每次执行的 JS 任务时间需要控制在 16ms 之内

如上图所示 FPS 图表页面运行期间期间帧率的概览。 由两部分组成：
红色条： 当出现红色条时说明帧数已经下降到影响用户体验的程度，颜色越深说明帧数越差
绿色的柱体：绿色条越高，帧率越好

### CPU

 FPS 下面的位置，即是 CPU 图表，可以看 CPU 图表被一些颜色填满，表示 CPU 正在处理某一类的任务

紫色：渲染

黄色：JS

蓝色：加载

绿色：绘制

灰色：其它

浅灰色：空闲

如果你看到了某个处理占用了大量的时间，那么这很可能就是一个性能瓶颈的线索

### NET

中间这一部分就是 NET 

每条横杆代表一种请求资源. 横杆越长，检索资源所需要的事件越长。每个横杆的浅色部分表示等待时间（请求资源到第一个字节下载完成时间）。

HTML文件是蓝色、脚本是黄色、样式是紫色、媒体文件是绿色、其它资源是灰色

这个地方太小了，基本看清楚，所以只适合看下大概，网络加载的信息还是直接看下面的 network 面板比较清楚

### heap( hiːp )

这里展示的 JS 内存使用情况，跟与 memory 表 中的 JS Heap 相同

如果反复切换同一页面，图表不断上升，说明可能存在内存泄漏问题

### Performance-Network面板

在 NetWork 部分，可以查看录制期间发生的网络请求情况. 如图所示面板出现了几个类似时间轴的线条，每条时间轴表示一个网络请求

不同颜色表示不同资源，前面已经有讲过了

每个请求的形状就像一个时间轴

左边的线：发请求前的时间

浅色块： 发起请求和等资源回应的时间

深色块： 内容下载的时间

右边线： 这个如果没搞错的话就是等待主线程时间

我们点击某个时间轴下面的 Summary 将会出现对应的概览信息

这个地方可以清查看到请求的先后顺序，我们可以通过顺序来看是否有优化的空间

然后结合 Network 里的 Timeline，可以得某个请求更多的信息

Queueing: 等待队列时间

Stalled: 是浏览器得到要发出这个请求的指令到请求可以发出的等待时间，一般是代理协商、以及等待可复用的TCP连接释放的时间，不包括DNS查询、建立TCP连接等时间等

DNS Lookup：DNS查询的时间，当本地DNS缓存没有的时候，这个时间可能是有一段长度的，但是比如你一旦在Host 中设置了 DNS，或者第二次访问，由于浏览器的DNS缓存还在，这个时间就为0了

Initial connection：建立TCP连接的时间，就相当于客户端从发请求开始到 TCP 握手结束这一段，包括 DNS查询+Proxy时间+TCP握手时间

Request sent： 请求第一个字节发出前到最后一个字节发出后的时间，也就是上传时间

Waiting(TTFB)：请求发出后，到收到响应的第一个字节所花费的时间(Time To First Byte),发送请求完毕到接收请求开始的时间;这个时间段就代表服务器处理和返回数据网络延时时间了。服务器优化的目的就是要让这个时间段尽可能短。

Content Download：收到响应的第一个字节，到接受完最后一个字节的时间，就是下载时间

### Performance-Frame 面板

Frames 面板可以更准确地告诉你一个特定的帧花费了多长时间，将鼠标移到某一个帧上面可以看到具体时间

Frame 面板不同的颜色意思为：

白色：空白帧，当前页面没有变化

绿色： 按预期及时渲染

黄色： 渲染了部分视图。例如在滚动的时候可能会出现

红色：不能在合理的时间内渲染框架

点击某一帧下面 Summary 面板也可以呈现出一些信息

悬浮框出现的信息 69.0ms ~ 14 fps Frame，解读为：

当前帧的持续时间为 69.0ms,即页面两次刷新之间间隔了 69.0ms

1000ms/69.0ms = 14.10 约等于 14

### Main 面板

这部分就是火焰图了，这里展示了一段时间内主线程上活动的任务信息

x 轴表示一段时间内的记录。 每个条形表示一个事件

宽条表示该事件花费了更长的时间

Y 轴表示调用堆叠。 当事件堆叠在一起时，这意味着上面的事件调用了下面的事件，也就是执行栈

面板中会有很多的 Task，如果是耗时长的 Task，其右上角会标红

我们可以选中标红的 Task，然后放大，看其具体的耗时点

放大后，这里可以看到都在做哪些操作，哪些函数耗时了多少

里面显示的代码是压缩后的，所以看到的也是压缩后的函数名。然后我们点击一下某个函数，在面板最下面，就会出现代码的信息，是哪个函数，耗时多少，在哪个文件上的第几行等。这样我们就很方便地定位到耗时函数了

### 内存面板

主要的监控指标包括：

CPU usage：CPU 占用率

JS head size：JS 内存使用大小

DOM Nodes：内存中挂载的 DOM 节点个数

JS event listeners：事件监听数

通过该图可以看出我们在不同的时间段的执行情况。我们可以看到页面中的内存使用的情况，比如 JS Heap(堆)，如果曲线一直在增长，则说明存在内存泄露，如果相当长的一段时间，内存曲线都是没有下降的，这里是有发生内存泄露的可能的

### 底部数据面板

**Summary**

详情面板选择因点击选择不同的目标统计的内容不同

未选择任何目标时，显示是某段时间内的各活动的占比

如果选择了具体目标时，比如 Main 中的某个函数，而显示该函数及期调用子函数的执行时等信息

**Bottom-Up**

此视图可以看到函数的执行时间占比，所以可以发现哪些函数对性能影响最大，并能够检查这些函数的调用路径

Bottom-Up 有三个标签 Self Time 和 Total Time 以及 Activity

Self Time: 函数本身执行消耗时间

Total Time: 函数本身消耗再加上在调用它的函数中消耗的总时间

Activity：至底向上展示活动的事件，类似事件冒泡的感觉，不断展开会发现最后一个就是根活动事件

这里的 Group 面板非常有用。我们可以很清晰明了得分析按照活动，目录，域，子域，URL和Frame进行分组的前端性能。对于开发非常有帮助

上图的例子可以发现 Activity 展开后跟上面的 Main 某个任务是能匹配上的


这里的 Group 面板非常有用。我们可以很清晰明了得分析按照活动，目录，域，子域，URL和Frame进行分组的前端性能。对于开发非常有帮助

上图的例子可以发现 Activity 展开后跟上面的 Main 某个任务是能匹配上的

**Call Tree**

Call Tree 其实跟 Bottom-Up 差不多的，只是它呈现的活动是至项向下


**Event Log：事件日志**

展示所有阶段包括 loading、 javascripting、rendering、painting 中各事件的耗时情况，并提供了 filter 输入框和按钮供你快速过滤

start time： 列表示活动开始时与录制开始相对的点。 例如，上图中所选项目 175.7 ms 的开始时间意味着录制开始 175.7 毫秒后活动开始。

self time: 自身活动所用时间

total time: 自身活动+其子活动总共执行时间


其实这四个标签要表现的东西是差不多的，只是呈现方式不一样

### 查看代码覆盖率

我们可以打开 Chrome Devtool Coverage 面板，查看当前使用资源的代码覆盖率，红色表示未使用到的代码

## Lighthouse

Lighthouse 也叫灯塔是 谷歌 推出的一款开源自动化工具，它可以搜集多个现代网页性能指标，分析 Web 应用的性能并生成报告，为开发人员进行性能优化的提供了参考方向。

如果前端介绍的 Performance - 适合运行过程中的性能分析

那么  Lighthouse - 更适合用于分析网站的加载性能

使用也很简单 点击 Generation Report 后就可以等待分析结果出来了， 出来的分析报表 如这个图

这个给出一些整体的分数，和一些性能指标的分数

这些分别表示什么意思，这里都对应的中文说明，这里就不念了

这张图表明的是 Lighthouse 给出的分数是根据权这些指标的权重计算得到的，也简单看一下

往下移可以看到报告给了优化建议，可以作为我们优化参数方向

下面有个 View Origin Trace 就会跳到前端 Performance 工具栏下，给出加载期间各资源的加载和运行情况，我们就可以具体去看看哪些地方存在问题

这些分数可以作为我们做性能优化时的目标，可以结合自己的项目属性找个优化方向进行优化

## 例子

理论知识都讲完了，接下就举几个使用例子

页面显示的时候出现很长的一段空白，从 Performance 报告中可以发现帖刷新出现了很长的阻塞情况

在 Frame 面板点击红色的帧，可以发现此帧阻塞了 7s 多

在 Main 面板查看期间的活动情况，发现有一个活动 updateAllZIndex 执行非常长，慢的原因就是这方法引起的




##  优化手段

- 防抖 截流

- 精简 data 属性

- 将耗时的任务分段处理

- 类似列表的功能控制 DOM 节点数量


