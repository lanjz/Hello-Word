# 编译

在Vue中编译就是把模板编译成`render`函数

# 编译过程

- 将模板转换成AST语法树

- 再将AST语法树转换`render`函数字符串，再通过`new Functon`方法将函数字符串转为一个函数

# 模板转换成AST

这里讲下Vue中的大致过程，具体的可以自己看源码，或者我简化后的代码，或者自己简单实现都可以

## 准备几个正则表达式

```javascript
const attribute = /^\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/ // 匹配属性
const dynamicArgAttribute = /^\s*((?:v-[\w-]+:|@|:|#)\[[^=]+\][^\s"'<>\/=]*)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/ // 匹配动态属性
const ncname = `[a-zA-Z_][\\-\\.0-9_a-zA-Z${unicodeRegExp.source}]*`
const qnameCapture = `((?:${ncname}\\:)?${ncname})`
const startTagOpen = new RegExp(`^<${qnameCapture}`) // 匹配开始标签如<div、<p
const startTagClose = /^\s*(\/?)>/ // 匹配标签的结束符尖括号>
const endTag = new RegExp(`^<\\/${qnameCapture}[^>]*>`) // 匹配结束标签
const doctype = /^<!DOCTYPE [^>]+>/i // 匹配DOCTYPE说明
// #7298: escape - to avoid being pased as HTML comment when inlined in page
const comment = /^<!\--/ // 匹配注释
const conditionalComment = /^<!\[/ // 匹配文档类型的节点
```

## 使用正则遍历整个模板字符串

这里我们通过一个例子`'<div :class="root">ABC<div v-for="(item, index) in list">{{item}}</div></div>'`来理解匹配过程

首先准备一个变量`index`表示当前的匹配位置，一开始的时候`index`的值为0，接下来通过几个`if`来查找，字符串的开头是否满足是开始标签还是结束标签，如果都不是则为文本内容

```javascript
let index = 0
while(html) {
	// 查找闭合标签
	const endTagMatch = html.match(endTag)
    if (endTagMatch) {
        const curIndex = index
        advance(endTagMatch[0].length)
        parseEndTag(endTagMatch[1], curIndex, index)
        continue
    }
    // 查找开始标签
    const startTagMatch = parseStartTag()
    if (startTagMatch) {
        handleStartTag(startTagMatch)
        if (shouldIgnoreFirstNewline(startTagMatch.tagName, html)) {
            advance(1)
        }
        continue
    }
    // 处理标签内容
}
```

上文中`advance`的作用，是如果匹配到符合的字符串，则将`index`向前推进匹配到的字符串的长度，直到字符串末尾

至于如何做到首属标签对称，其实这里使用到了一个栈`stack`来保存匹配到标签，具体过程如下

- 当匹配到一个开始标签，则将这个标签推入栈中，继续匹配

- 当匹配到是一个结束标签的话，那么这个标签名应与栈中最后一个标签名一致，此时将最后一个标签名从栈量推出

- 如果匹配到的是一个单标签，则不需推入栈中，直接处理

- 以此类推，将字符串匹配完时，栈的长度应0

这里需要说明的是，我们往栈中保存的不是一个标签字符串，而一个AST节点，即标签信息。在匹配开始标签的时候，即上文代码`parseStartTag()`函数中，
主要做以下几件事情

- 通过正则判断是否符合开始标签

- 如果符合，并则通过正则查找标签中的所有的属性，分别通过`map`和`Array`的形式保存，
然后将标签名，属性信息等保存到一个对象中

- 对这个对象做进一步处理，如何这个标签属性中包含Vue中内置指定，如`v-if`、`v-for`等，还会分别做下处理，
最后生成一个AST节点，保存到栈中
