<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>观察者模式实现数据双向绑定demo</title>
    <style>
        .label{
            width: 70px;
            display: inline-block;
            padding: 5px 10px;
        }
        input{
            margin-right: 20px;
        }
        button{
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h2>观察者模式实现数据双向绑定demo</h2>
    <div><span class="label">数字：</span><input type="text" data-bind-user="number" style="border: 1px solid #ccc; width:200px; height: 24px; " /><span data-bind-objId="number" ></span></div>
    <div><span class="label">姓名：</span><input type="text" data-bind-user="name" style="border: 1px solid #ccc; width:200px; height: 24px; " /><span data-bind-objId="name" ></span></div>
    <button id="btn">model的变化导致view的变化</button>
</body>
<script>
    const Observer = function () {
        this.obs = {}
        this.listen = function (key, fn) {
        	if(!this.obs[key]) {
				this.obs[key] = []
            }
			this.obs[key].push(fn)
			console.log(`${key}成功添加订阅消息${fn}`)
		}
		this.public = function () {
			// 取第一个参数
			const key = Array.prototype.shift.call(arguments)
			const listObs = this.obs[key]
			if(listObs) {
				listObs.forEach((fn) => {
					fn(...arguments)
				})
			}
		}
	}
	function DataBinder(modal) {
    	console.log('model', modal)
		// 添加订阅者，查找所有绑定这个dataId的元素，并根据属性改变值
        const newObj = new Observer()
		newObj.listen(modal.id, function (key, newVal) {
			const elements = document.querySelectorAll(`[data-bind-${modal.id}=${key}]`)
            elements.forEach(item => {
            	let tagName = item.tagName.toLowerCase();
				if (tagName === 'input' || tagName === 'textarea' || tagName === 'select') {
					item.value = newVal;
				} else {
					item.innerHTML = newVal;
				}
            })
		})
		function changeHandler(e) {
			const target = e.target
			const attrName = target.getAttribute("data-bind-"+modal.id);
			modal.set(attrName, target)
		}
		// 全局监听Input事件，其实只要兼容绑定了模型的input框就可以了，这里为了方便
		document.addEventListener('input', changeHandler, false);
        return newObj
	}

	class ModelData{
    	constructor(dataKey) {
    		this.id = dataKey
            this.attr = {}
			this.binder = new DataBinder(this)
        }
        set(key, value) {
			this.attr[key] = value;
			// 当前发生变化后，通过订阅者
			this.binder.public(this.id, key, value);
        }
        get(key) {
			return this.attr[key];
        }
    }
/*	function ModelData(dataKey) {
    	const Obj = {
    		id: dataKey,
			attr: {}
		}
		const binder = new DataBinder(Obj)
        Obj.prototype = {
			set: function (key, value) {
				this.attr[key] = value;
				// 当前发生变化后，通过订阅者
				binder.public(dataKey, key, value);
			},
			get: function (key) {
				return this.attr[key];
			}
        }
		return Obj;
	}*/
	// 测试demo
	const user = new ModelData("user");
	user.set("number", 1);
	// 测试模型的变化到视图层的变化
	const btn = document.getElementById("btn");
	const inputId = document.getElementById("inputId");
	btn.onclick = function () {
		const value = inputId.value;
		user.set("number", parseInt(value) + 1);
	};
	console.log('user', user)
</script>
</html>
