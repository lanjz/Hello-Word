# 观察者模式

观察者模式，又称发布者-订阅者模式。当对象间存在一对多关系时，则使用观察者模式（Observer Pattern）。
比如，当一个对象被修改时，则会自动通知它的依赖对象。观察者模式属于行为型模式。

先来理解下 现实生活中的发布-订阅模式

比如小红最近在淘宝网上看上一双鞋子，但是呢 联系到卖家后，才发现这双鞋卖光了，但是小红对这双鞋又非常喜欢，所以呢联系卖家
，问卖家什么时候有货，卖家告诉她，要等一个星期后才有货，卖家告诉小红，
要是你喜欢的话，你可以收藏我们的店铺，等有货的时候再通知你，所以小红收藏了此店铺，
但与此同时，小明，小花等也喜欢这双鞋，也收藏了该店铺；等来货的时候就依次会通知他们；

在上面的故事中，可以看出是一个典型的发布订阅模式，卖家是属于发布者，小红，小明等属于订阅者，订阅该店铺，卖家作为发布者，当鞋子到了的时候，会依次通知小明，小红等。

在JavaScript中观察者模式常用于事件绑定中

```
div.onclick = function click (){
   alert ( 'click' )
}
```

我们希望用户点击div的时候，触发一下`alert ( 'click' )`，但是我们并不确定用户什么时候会触发点击事件，所以在div上订阅执行事件，
当用户点击了div，那么就会执行函数

这里订阅者就是执行函数、订阅了`div`的click事件

## 发布订阅模式的优点：

1. 支持简单的广播通信，当对象状态发生改变时，会自动通知已经订阅过的对象。

2. 发布者与订阅者耦合性降低，发布者只管发布一条消息出去，它不关心这条消息如何被订阅者使用，同时，订阅者只监听发布者的事件名，只要发布者的事件名不变，它不管发布者如何改变；

## 发布订阅模式的缺点：

1. 创建订阅者需要消耗一定的时间和内存。

2. 虽然可以弱化对象之间的联系，如果过度使用的话，反而使代码不好理解及代码不好维护等等。

# 自定义观察者模式

```
 function obs() {
    const obj = {}
    const _this = this
    const listen = function (key, fn) {
      const tmp = obj[key] ? obj[key] : obj[key] = []
      tmp.push(fn)
      console.log(`${key}成功添加订阅消息${fn}`)
    }
    const one = function (key, fn) {
      _this.moveAll(key)
      _this.listen(key, fn)
    }
    const moveAll = function (key) {
      if(obj[key]) {
        obj[key].length = 0
        console.log(`${key}成功取消所有订阅消息`)
      }
    }
    const moveOne = function (key, fn) {
      if(obj[key]) {
        const findIndex = obj[key].findIndex(item => item === fn)
        obj[key].splice(findIndex, 1)
        console.log(`${key}成功取消订阅消息${fn}`)
      }
    }
    const send = function () {
      // 取第一个参数
      const key = Array.prototype.shift.call(arguments)
      const list = obj[key]
      if(list) {
        list.forEach((fn) => {
          fn()
        })
      }
    }
    const get = function () {
      return obj
    }
    return {
      listen,
      one,
      moveOne,
      moveAll,
      send,
      get
    }
  }
  const newObs = obs()
  const role1Fn = function () {
    console.log('我是role1，吃饭')
  }
  const role2Fn = function () {
    console.log('我是role2，游泳')
  }
  const role2Fn2 = function () {
    console.log('我是role2，再来一次游泳')
  }
  newObs.listen('role1', role1Fn) // role1成功添加订阅消息function () {  console.log('我是role1，吃饭') }
  newObs.listen('role2', role2Fn) // role1成功添加订阅消息function () {  console.log('我是role2，游泳') }
  newObs.listen('role2', role2Fn2)// role1成功添加订阅消息function () {  console.log('我是role2，再来一次游泳') }
  console.log('当前订阅：')
  console.log(newObs.get())
  newObs.moveOne('role2', role2Fn2)
  console.log('当然订阅：')
  console.log(newObs.get())
  newObs.send('role2') // 我是role2，游泳, 我是role2，再来一次游泳
```
