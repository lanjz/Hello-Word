> [Git：vue-router](https://github.com/vuejs/vue-router/tree/dev/src)

> [Vue.js 技术揭秘](https://ustbhuangyi.github.io/vue-analysis/vue-router/)

# Hash模式和History模式

所谓路由的特点就是URL地址改变了，但不会重新加载页面，但我们又可以监测到URL地址的变化，当变化时执行一些行为。

为了达到这个目的，目前浏览器提供了两个方式：hash模式和history模式

## Hash模式

hash就是url地址后面带#符号的字符串。获取当前地址的hash可以通过`window.location.hash`属性获得。

比如对于地址`http://blackhook.club#index`

```
window.location.hash //  #index
```

通过`onhashchange`方法，可以监听地址上hash的变化

```
window.onhashchange = function(event){
  console.log(event.oldURL, event.newURL);
}
```

## History模式 [MDN-History](https://developer.mozilla.org/zh-CN/docs/Web/API/History)

History接口允许操作浏览器访问的会话记录

History接口提供了以下方法：

- History.back()：前往上一页，相当于点击了浏览器中的后退按钮

- History.forward()：前往下一页，相当于点击了浏览器中的下一页按钮，如果没有下一页，则没反应

- History.go()：通过当前页面的相对位置访问浏览器中的记录。`History.go(-1)`相当于`History.back()`

- [History.pushState()](https://developer.mozilla.org/zh-CN/docs/Web/API/History_API)：添加历史记录条目。使用History.pushState()时，可以改变地址中显示的地址，请求时`refferer`参数也会修改，但不会导致页面重新加载

    - 需要三个参数：

      - 状态对象：一个JS对象，可以存放一些信息，规定这个状态对象序列化表示后不能超过640k的大小，通过history.state可以获取这个状态

      - 标题：暂时忽略

      - URL：该参数定义了新的历史URL记录

    ```
    // 比如当前在页面http://www.blackhook.club
    window.history.pushState({test:123}, '', '/asd')
    // 页面的URL变成为了http://www.blackhook.club/asd
    window.hisotry.state // {test: 123}
    ```
    
- History.replaceState()：用法跟`History.pushState()`类似，区别在于`History.replaceState()`是修改当前的记录，`History.pushState()`是添加一条历史记录

### History.onpopstate事件

当某项历史记录激活时，将触发History.onpopstate事件

- `History.replaceState()`和`History.pushState()`只是修改历史记录条目
所以不会触发`History.onpopstate`事件

- `history.back()`、`history.forward()`、`history.go()`可以触发`History.onpopstate`事件

  ```
window.onpopstate = function(event) {
  alert("location: " + document.location + ", state: " + JSON.stringify(event.state));
};
//绑定事件处理函数. 
history.pushState({page: 1}, "title 1", "?page=1");    //添加并激活一个历史记录条目 http://example.com/example.html?page=1,条目索引为1
history.pushState({page: 2}, "title 2", "?page=2");    //添加并激活一个历史记录条目 http://example.com/example.html?page=2,条目索引为2
history.replaceState({page: 3}, "title 3", "?page=3"); //修改当前激活的历史记录条目 http://ex..?page=2 变为 http://ex..?page=3,条目索引为3
history.back(); // 弹出 "location: http://example.com/example.html?page=1, state: {"page":1}"
history.back(); // 弹出 "location: http://example.com/example.html, state: null
history.go(2);  // 弹出 "location: http://example.com/example.html?page=3, state: {"page":3}
  ```

即便进入了那些非pushState和replaceState方法作用过的网页, popstate事件也仍然会被触发.

## 后端支持

当使用history模式时，如果后台没有正确的配置，当用户在浏览器直接访问`http://www.blackhook.club/b`时，就会返回404。因为我们正常不存在这个页面

所以，需要在服务端增加一个覆盖所有情况的候选资源：如果URL匹配不到任何静态资源，则应该返回同一个`index.htlm`页面，主个页面就是app依赖的页面

nginx配置例子：

```
location / {
  try_files $uri $uri/ /index.html;
}
```

其它参数：[vue router 后端配置](https://router.vuejs.org/zh/guide/essentials/history-mode.html#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%BE%8B%E5%AD%90)

