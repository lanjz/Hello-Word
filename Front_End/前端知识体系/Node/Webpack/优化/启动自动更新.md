# 文件监听

文件监听是发现源码文件发生变化时，自动重新编译出新的输出文件

Webapck官方提供了两个大模块，一个核心的webpack，另一个是webpack-dev-server。而文件监听功能是Webpack提供的

文件监听的相关配置：

```
  module.exports = {
    // 开启监听模式，默认是false
    watch: true,
    // 前提是要watch为true，要不然没意义
    // 监听模式运行时的参数
    watchOptions: {
      // 不监听的文件或文件夹，支持正则匹配
      ignored: /node_modules/,
      // 监听到变化后等300ms再去执行，截流
      aggregateTimeout: 300,
      // 判断文件是否发生变化是通过不断询问系统指定文件有没有更新实现的
      // 默默每秒询问1000次
      poll: 1000
    }
  }
``` 

Webpack开启文件监听有两种方式

1. 配置文件中设置`watch: true`

2. 在执行启动Webapck的命令时带上`--watch`参数，完整的命令是`webapck --watch`

### 文件监听的原理

在Webpack中监听一个文件是否发生变化的原理，是定时获取这个文件最后更新时间，每次都存下最新的更新时间，如果发现当前时间获取的和最后一次保存的编辑时间不一致，就认为该发生了变化 。配置项中的watchOptions.poll用于控制定时检查的周期，具体含义是每秒检查多少次。

### 怎么确定要监听的文件列表呢？

在默认情况下，Webapck会从配置的Entry文件出发，递归解析Entry文件所依赖的文件，将这些文件加入到监听列表中。

由于保存文件的路径和最后的编辑时间需要占用内存，定时检查、周期检查需要占用CPU及文件I/O，所以最好减少需要监听的文件数量和降低检查频率。

## 优化文件监听的性能

根据前面对文件监听的原理介绍，我们可以做以下优化：

- 需要监听的文件列表是根据Entry配置的入口文件递归得将引用到的文件加入到监听列表中，其中将包含很多的`node_modules`中的模块，一般情况下我们不会修改`node_moduels`里的文件，所以我们可以忽略这个文件的监听，相关配置如下：

```
module.exports = {
  watchOptions: {
  // 不监听node_module中的文件
   ignored: /node_modules/，
  }
}
```

- 配置截流，`watchOptions.aggregateTimeout`的值越大越好，因为这能降低重新构建的频率

- `watchOptions.pool`的值越小越好，因为这能降低检查的频率

后面这种方式的优化，负作用是监听模式的反应和灵敏度降低了

# 自动刷新浏览器

监听到文件的变化后，下一步就是刷新浏览器，webpack模块负责监听文件，webapck-dev-server负责刷新浏览器。使用webpack-dev-server模块去启动webpack模块时，webpack模块的监听模式默认会被开启。当webpack模块监听到文件变化时，会通过webpack-dev-server模块

## 自动刷新的原理

控制浏览器刷新有如下三种方式

- 借助浏览器扩展去通过浏览器提供的接口刷新，Webstorm IDE的LiveEdit功能就是这样实现的

- 向要开发的网页中注入代理客户端代码，通过代理客户端去刷新整个页面

- 将要开发的网页装进一个iframe中，通过刷新iframe去看到最新效果

DevServer支持第2和第3种方法，第2种是DevServer默认采用的刷新方法。

通过DevServer启动构建

用浏览器调试工具，可以发现由代理客户端向DevServer发起的WebSocket连接。

### 优化自动刷新的性能

在使用devServer.inline配置项时，它用来控制 是否向Chunk中注入代理客户端，默认会注入。事实上，在开启Inline时，DevServer会向每个输出的Chunk中都注入代理客户端的代码，当我们需要输出多个Chunk时，就会导致构建缓慢。其实要完成自动刷新 ，一个页面只需要一个代理客户端，DevServer之所有这么粗暴得给每个输出的Chunk注入代理客户端代码，是因为它不知道页面依赖哪几个Chunk，所以索性全部都注入一个代理客户端。网页只要依赖了其中任何一个Chunk，代理客户端就被注入网页中。

这里的优化思路是关闭不够优雅的Inline模式，只注入一个代理客户端。为了关闭inline模式，在启动DevServer时可以通过执行命令`webpack-dev-server --inline false`(也可以在配置文件中设置)

关闭inline模式后和前面的不同在于：

- 入口网址变成了`http://localhost:8080/webpack-dev-server`

- bundle.js中不再包含代理客户端的代码。

- 查看页面的源代码我们发现，我们要开发的网页被放进了一个iframe中，编辑源码后，iframe会被自动刷新。

如果不想用iframe的方式去自动刷新网页，但同时想让网页保持自动刷新的功能，则需要手动在网页中注入代理客户端代码，向index.html中插入以下标签：

```
<!--注入DevServer提供的代理客户端脚本，这个服务是DevServer内置的-->
<script src="http://localhost:8080/webpack-dev-server.js"></script>
```


