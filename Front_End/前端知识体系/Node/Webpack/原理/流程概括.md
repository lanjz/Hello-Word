## 流程概括

Webpack的运行过程是一个串行的过程，从启动到结束会经过以下过程：

- 初始化参数：从配置文件和Shell语句中读取与合并参数，得出最终的参数

- 开始编译：用上一步得到的参数初始化Compiler对象，加载所有配置的插件，通过执行对象的run方法开始执行编译

- 确定入口：根据配置中的entry配置找出所有的入口文件

- 编译模块：从入口文件出发，调用所有配置的Loader对模块进行翻译，再找出该模块所依赖的模块，递归本步骤直到所有依赖的模块都经过此步骤

- 完成模块的编译：经过上一步Loader的翻译这后，得到了每个模块被翻译后的结果有它们之间的依赖关系

- 输出资源 ：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的Chunk，再将Chunk转换成一个单独的文件加入输出列表中，这是可以修改输出内容的最后机会

- 输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，将文件的内容写入文件系统中

## 流程细节

Webpack的构建流程大致可以分为以下三个阶段

1. 初始化：启动构建，读取与合并配置参数，加载Plugin，实例化Compiler.

2. 编译：从Entry发出，针对每个Module串行调用对应的Loader去翻译文件的内容，再找到该Module依赖的Module，递归地进行编译处理

3. 输出：将编译后的Module组合成Chunk，将Chunk转换成文件，输出到文件系统中

### 初始化阶段

初始化阶段会发生的事件及解释如下：

- 初始化参数：从配置文件和Shell语句中读取并合并参数，得出最终的参数。在这个过程中还会执行配置文件中的插件实例化语句new Plugin()

- 实例Compiler：用上一步得到的参数初始化Compiler实例，Compiler负责文件的监听和启动编译。在Compler实例中包含了完整的Webpack配置，全局只有一个Compiler实例

- 加载插件：依次调用插件的apply方法，让插件可以监听后续的所有事件节点。同时向插件传入Compiler实例的引用，以方便插件通过Compiler调用Webpack提供的API

- environment：开始应用Node.js风格的文件系统到Compiler对象，以方便后续的文件寻找和读取

- evtry-option：读取配置的Entrys，为每个Entry实例化一个对应的EntryPlugin，为后面该Entry的递归解析工作做准备

- after-plugin：调用完所有内置的和配置的插件的apply方法

- after-resolvers：根据配置初始resovler,resovler负责在文件系统中寻找指定路径的文件

### 编译阶段

编译阶段会发生的事件及解释如下：

- run：启动一次新的编译

- watch-run：和run类似，区别在于它是监听模式下启动编译，在这个事件中可以获取是哪些文件发了变化从而导致重新启动一次编译

- compile：该事件是为了告诉插件一次新的编译将要启动，同时会给插件带上Compiler对象

- compilation：当Webpack以及开发模式运行时，每当检测到文件发生了变化，便有一次新的Compilation被创建。一个Compilation对象包含了当前的模块资源 、编译生成资源 、变化的文件等。Compilation对象也提供了很多事件回调给插件进行扩展

-make：一个新的compilatin创建后，即从Entry配置的入口文件开发，根据配置的Loder对这个入口文件及依赖的模块进行递归的编译和解析

- after-compile：一次compilation编译完成

- invalid：当遇到文件不存在、文件编译发生错误等异常情况会触发该事件，该事件不会导致Webpack退出 

其中compilation事件又包含了几个小事件

- build-module：使用对应的Loader去转换一个模块

- 在用Loader转换完一个模块后，使用acorn解析转换后的内容，输出对应的抽象语法树（AST），以方便Webpack在后面对代码进行分析

- program：从配置的入口模块开始，分析其AST，当遇到import等导入其它模块的语句时，便将其加入依赖的模块列表中，同时对新找的依赖模块做递归分析，最终弄清楚所有模块的依赖关系

- seal：所有模块及其依赖的模块都通过Loader转换完成，根据依赖关系开始生成Chunk

## 输出编译

输出编译阶段会发生的事件及解释如下：

- should-emit：所有需要输出的文件已经生成，询问插件哪些文件需要输出，哪些文件不需要输出

- emit： 确定好要输出的文件之后，执行文件输出，可以在这里获取和修改输出的内容

- after-emit： 文件输出完成

- done：成功完成一次完整的编译和输出流程

- failed： 如果在编译和输出的流程中遇到异常，导致Webpack退出，就会直接跳转到本步骤，插件可通过本事件中获取到具体的错误原因
