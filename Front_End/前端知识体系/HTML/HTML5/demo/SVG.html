<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        canvas{
            /*border: solid 1px #000;*/
        }
    </style>
</head>
<body>
<!--<svg width="660" height="220" style="outline: 1px solid red; font-size: 2em; overflow: visible;"> <text x="240" y="120"> <tspan>SVG</tspan> <tspan>SVG</tspan> </text> </svg>著作权归作者所有。-->
<svg version="1.1"
     baseProfile="full"
     width="300" height="200"
     xmlns="http://www.w3.org/2000/svg">

    <rect width="100" height="100" fill="red"/>
<!--    <text x="10" y="10" fill="red">Hello World!</text>-->
    <path d="M50 100 C 100 100, 300 100, 300 50" stroke="black" fill="transparent"/>
    <text y="0"  text-anchor="start">Hello</text>
    <!--    <circle cx="10" cy="10" r="2" fill="red"/>-->
</svg>
</body>
<script>

    const cSvg = {
        svgDom: null,
        svgGroup: null,
        reactStyle: { // 文本样式
            textPadding: 5, // 文字与边框的间距
            verticalMargin: 10, // 元素上下间距
            rowMargin: 80, // 元素左右间距
            minWidth: 50, // 元素最小宽度
            reactRadius: 5, // 元素圆角
        },
        lineStyle: { // 线条样式
            style: 'stroke:rgb(255,0,0)',
            'stroke-width': 2
        },
        // 创建SVG根元素
        cSvgDom: function () {
            const svgDom = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svgDom.setAttribute('width','2000');
            svgDom.setAttribute('height','2000');
            svgDom.setAttribute('version','full');
            svgDom.setAttribute('baseProfile','baseProfile');
            svgDom.setAttribute('xmlns','http://www.w3.org/2000/svg');
            return svgDom
        },
        // 创建SVG-文本元素
        cText: function (txt, attr = {}) {
            const el = document.createElementNS('http://www.w3.org/2000/svg','text');
            attr = {
                dominantBaseline: 'middle',
                fill: 'red',
                ...attr
            }
            Object.keys(attr).forEach(item => {
                el.setAttribute(item, attr[item]);
            })
            el.textContent = txt
            return el
        },
        // 创建SVG-元素
        cEl: function (tag, attr) {
            attr = {
                fill: '#000',
                ...attr,
            }
            const el = document.createElementNS('http://www.w3.org/2000/svg',tag);
            Object.keys(attr).forEach(item => {
                el.setAttribute(item, attr[item]);
            })
            return el
        },
        // 创建SVG-ellipse元素
        /**
         * @params {String} text: 文字
         * @params {Number} height: 垂直偏移量
         * */
        cReact: function (text, hei = 0) {
            const { textPadding, reactRadius, minWidth } = this.reactStyle
            const cG = this.cG()
            let sText = this.cText(text,{y: hei})
            cG.appendChild(sText)
            const {width, height} = this.getRect(cG)
            sText.setAttribute('transform', `translate(${textPadding}, ${height})`);// 默认情况文本向偏上，不能垂直居中，所以纠正一下
            const sEllipse = this.cEl('rect', {
                x: 0,
                y: hei,
                width: Math.max((width + textPadding * 2), minWidth),
                height: height + textPadding * 2,
                rx: reactRadius,
                ry: reactRadius
            })
            cG.prepend(sEllipse)
            return cG
        },
        // 创建组
        cG: function(attr = {}) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')
            Object.keys(attr).forEach(item => {
                g.setAttribute(item, attr[item]);
            })
            return document.createElementNS('http://www.w3.org/2000/svg', 'g')
        },
        /**
         * 获取元素几何信息，需要在DOM才能得到这些信息，所以先执行appendChild
         * 要注意appendChild后修改节点位置，所以切勿在插入到正确位置后再执行这个方法
         * */
        getRect: function(g){
            this.svgGroup.appendChild(g)
            return g.getBBox()
        },
        /**
         * @params {svg[g]} a 左侧的g元素
         * @params {svg[g]} b a对应的子元素
         * */
        combine: function(a, b) {
            const cG = this.cG()
            const x = `${this.getRect(a).width + this.reactStyle.rowMargin}` // 计算a,b的间距
            const y = this.findMiddlePosition(b) // 计算a在b垂直方向的中间位置
            const {y: aY, width: aWidth, height: aHeight } = this.getRect(a) // 当前A的几何信息
            b.setAttribute('transform', `translate(${x}, ${aY})`) // b的整体Y偏移要与a元素保持一致
            a.childNodes.forEach(node => {
                node.setAttribute('y', y+aY) // （步骤A）相对b的居中位置 + 原本的偏移量
            })

            cG.appendChild(a)
            cG.appendChild(b)
            // 画线
            b.childNodes.forEach(item => {
                const {y: positionY, height} = this.findPositionElY(item) // 获取元素在当前组内的Y偏移量
                const line = this.cEl('line', {
                    x1: aWidth,
                    y1: (aY + y) + aHeight/2, // 这里的aY是上面步骤A之前的值，所以需要（aY + y）才是a真实Y偏移量
                    x2: x,
                    y2: Number(positionY) + Number(aY)+height/2, // 元素在组内偏移量+组的偏移量+相对右侧居中的偏移量
                    ...this.lineStyle
                })
                cG.appendChild(line)
            })
            return cG
        },
        /**
         *  获取子元素集合中的垂直居中位置
         *  g元素没有记录几何信息
         *  通过查找g元素下的非g元素，来获取当前g的垂直偏移量
         * */
        findMiddlePosition:function(el){
            let firstEl = el.firstChild
            while (firstEl.tagName === 'g'){
                firstEl = firstEl.firstChild
            }
            let lastEl = el.lastChild
            while (lastEl.tagName === 'g'){
                lastEl = lastEl.firstChild
            }
            const result = (lastEl.getAttribute('y') - firstEl.getAttribute('y')*1) / 2 + firstEl.getAttribute('y')*1
            return result
        },
        // 获取某在元素在当前组内的Y偏移量
        findPositionElY: function(el){
            while (el.tagName === 'g'){
                el = el.firstChild
            }
            return {
                y: el.getAttribute('y'),
                width: el.getAttribute('width'),
                height: el.getAttribute('height'),
            }
        },
        // 将同父的元素放同一个组中
        bindG: function(svgElArr) {
            const cG = this.cG()
            svgElArr.forEach((item, ind) => {
                cG.appendChild(item)
            })
            return cG
        },
        init: function (tree) {
            this.svgDom = this.cSvgDom()
            document.body.appendChild(this.svgDom)
            this.svgGroup = this.cG()
            this.svgDom.appendChild(this.svgGroup)
            const rootG = this.initWalk(tree)
            this.svgGroup.appendChild(rootG)
        },
        // 处理根元素
        initWalk: function(tree) {
            const gGroup = this.walk(tree)
            return gGroup
        },
        walk: function (tree) {
            const svgElArr = []
            let hei = 0 // 设置每个元素的偏移高度
            tree.forEach((item) => {
                let svgEl = this.cReact(item.name, hei) // 返回某个文本G
                if(item.children && item.children.length) { // 如果有子节点，则递归子节点后再与当前节点合并成一个大组
                    const childSvgEl  = this.walk(item.children)
                    svgEl = this.combine(svgEl, childSvgEl)
                }
                hei += ((this.getRect(svgEl)).height + this.reactStyle.verticalMargin)
                svgElArr.push(svgEl)
            })
            return this.bindG(svgElArr) // 返回组成G
        },
    }
    console.log(cSvg)
/*    const svgDom = cSvg.cSvgDom()

    const sRect = cSvg.cEl('rect', {
        width: '100',
        height: '100',
        fill: 'red',
    })
    console.log('sRect', sRect.width)
    svgDom.appendChild(sRect)
    const sText  = cText('LAN', {
        fill: '#000',
        x: '100',
        y: '100',
    })
    console.log('sText', sText.textLength)
    svgDom.appendChild(sText)
    document.body.appendChild(svgDom);*/
</script>
<script>

    const tree2 = [
        {
            name: '1-1-1',
            children: [
                {
                    name: '1-1-1-1',
                    children: [
                        {
                            name: 'a-1-3-1',
                        },
                        {
                            name: 'a-1-3-2'
                        },
                        {
                            name: 'a-1-3-3',
                            children: [
                                {
                                    name: 'a-1-3-1',
                                    children: [
                                        {
                                            name: 'a-1-3-1',
                                        },
                                        {
                                            name: 'a-1-3-2'
                                        },
                                        {
                                            name: 'a-1-3-3'
                                        },
                                        {
                                            name: 'a-1-3-4'
                                        }
                                    ]
                                },
                                {
                                    name: 'a-1-3-2'
                                },
                                {
                                    name: 'a-1-3-3'
                                },
                                {
                                    name: 'a-1-3-4'
                                }
                            ]
                        },
                        {
                            name: 'a-1-3-4'
                        }
                    ]
                },
                {
                    name: '1-1-1-2'
                }
            ]
        },
        {
            name: '1-1-2',
            children: [
                {
                    name: '1-2-1',
                },
                {
                    name: '1-2-2'
                },
                {
                    name: '1-2-3'
                },
                {
                    name: '1-2-4'
                }
            ]
        },

        {
            name: '1-1-3',
            children: [
                {
                    name: '1-1-3-1',
                    children: [
                        {
                            name: '1-2-1',
                        },
                        {
                            name: '1-2-2'
                        },
                        {
                            name: '1-2-3'
                        },
                        {
                            name: '1-2-4'
                        }
                    ]
                },
                {
                    name: '1-1-3-2'
                }
            ]
        }
    ]
    const tree = [
        {
            name: '1',
            type: 'dir',
            children: [
                {
                    name: '1-1',
                    children: [
                        {
                            name: '1-1-1',
                        },
                        {
                            name: '1-1-2'
                        }
                    ]
                },
                {
                    name: '1-2',
                    children: [
                        {
                            name: '1-2-1',
                        },
                        {
                            name: '1-2-2'
                        },
                        {
                            name: '1-2-3'
                        },
                        {
                            name: '1-2-4'
                        }
                    ]
                },
                {
                    name: '1-3',
                    children: [
                        {
                            name: '1-3-1',
                        },
                        {
                            name: '1-3-2'
                        },
                        {
                            name: '1-3-3'
                        },
                        {
                            name: '1-3-4'
                        }
                    ]
                }
            ]
        }
    ]
    cSvg.init(tree2)
</script>
</html>