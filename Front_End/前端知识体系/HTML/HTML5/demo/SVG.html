<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        canvas{
            /*border: solid 1px #000;*/
        }
    </style>
</head>
<body>
<!--<svg width="660" height="220" style="outline: 1px solid red; font-size: 2em; overflow: visible;"> <text x="240" y="120"> <tspan>SVG</tspan> <tspan>SVG</tspan> </text> </svg>著作权归作者所有。-->
<svg version="1.1"
     baseProfile="full"
     width="300" height="200"
     xmlns="http://www.w3.org/2000/svg">

    <rect width="100" height="100" fill="red"/>
<!--    <text x="10" y="10" fill="red">Hello World!</text>-->
    <path d="M50 100 C 100 100, 300 100, 300 50" stroke="black" fill="transparent"/>
    <text y="0"  text-anchor="start">Hello</text>
    <!--    <circle cx="10" cy="10" r="2" fill="red"/>-->
</svg>
</body>
<script>

    const cSvg = {
        svgDom: null,
        svgGroup: null,
        textPadding: 5,
        maxVertical: 0,
        virtualSvg: {
            root: {
                children: []
            }
        },
        // 创建SVG根元素
        cSvgDom: function () {
            const svgDom = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svgDom.setAttribute('width','2000');
            svgDom.setAttribute('height','2000');
            svgDom.setAttribute('version','full');
            svgDom.setAttribute('baseProfile','baseProfile');
            svgDom.setAttribute('xmlns','http://www.w3.org/2000/svg');
            return svgDom
        },
        // 创建SVG-文本元素
        cText: function (txt, attr = {}) {
            const el = document.createElementNS('http://www.w3.org/2000/svg','text');
            attr = {
                dominantBaseline: 'middle',
                fill: 'red',
                ...attr
            }
            Object.keys(attr).forEach(item => {
                el.setAttribute(item, attr[item]);
            })
            el.textContent = txt
            return el
        },
        // 创建SVG-元素
        cEl: function (tag, attr) {
            attr = {
                fill: '#000',
                ...attr,
            }
            const el = document.createElementNS('http://www.w3.org/2000/svg',tag);
            Object.keys(attr).forEach(item => {
                el.setAttribute(item, attr[item]);
            })
            return el
        },
        // 创建SVG-ellipse元素
        /**
         * @params {String} text: 文字
         * */
        cReact: function (text, parent, ind, len) {
            const g = this.cG()
            this.svgDom.appendChild(g)
            let sText = this.cText(text,{
            })
            g.appendChild(sText)
            const {x: tX, y: tY, width, height} = sText.getBBox()
            // 默认情况文本向偏上，不能垂直居中，所以纠正一下
            sText.setAttribute('transform', `translate(${this.textPadding}, ${Math.abs(tY) + this.textPadding})`);
            const sEllipse = this.cEl('rect', {
                x: 0,
                y: 0,
                width: Math.max((width + this.textPadding * 2), 50),
                height: height + this.textPadding * 2,
                rx: 5,
                ry: 5
            })
            const middleInd = (len-1)/2
            const offsetVertical = len > 1 ? (ind - middleInd) * 100 : 0
            const offsetHorizontalDis = parent.horizontalDis || 0
            this.maxVertical = Math.min(offsetVertical, this.maxVertical)
            g.setAttribute('transform', `translate(${offsetHorizontalDis}, ${offsetVertical})`);
            g.prepend(sEllipse)
            return g
        },
        cG: function() {
            return document.createElementNS('http://www.w3.org/2000/svg', 'g')
        },
        init: function (tree) {
            this.svgDom = this.cSvgDom()
            this.svgGroup = this.cG()
            this.svgDom.appendChild(this.svgGroup)
            document.body.appendChild(this.svgDom)
            this.walk(tree)
            this.svgGroup.setAttribute('transform', `translate(0, ${Math.abs(this.maxVertical)})`)
        },
        walk: function (tree, parent = {}) {
            tree.forEach((item, index) => {
                const svgEl = this.createVirtualSvg(item, parent, index, tree.length)
                const curEl = {
                    ...item,
                    svgNode: svgEl,
                    parent,
                    children: [],
                    horizontalDis: parent.horizontalDis ? parent.horizontalDis+100: 100
                }
                if(!this.virtualSvg[parent.name || 'root']) {
                    this.virtualSvg[parent.name || 'root'] = {
                        children: []
                    }
                }
                this.virtualSvg[parent.name || 'root'].children.push(curEl)
                if(item.children && item.children.length) {
                    this.walk(item.children, curEl)
                }
            })
        },
        createVirtualSvg: function (item, parent, index, len) {
            const svgNode = this.cReact(item.name, parent, index, len)
            return svgNode
        }

    }
    console.log(cSvg)
/*    const svgDom = cSvg.cSvgDom()

    const sRect = cSvg.cEl('rect', {
        width: '100',
        height: '100',
        fill: 'red',
    })
    console.log('sRect', sRect.width)
    svgDom.appendChild(sRect)
    const sText  = cText('LAN', {
        fill: '#000',
        x: '100',
        y: '100',
    })
    console.log('sText', sText.textLength)
    svgDom.appendChild(sText)
    document.body.appendChild(svgDom);*/
</script>
<script>

    const tree = [
        {
            name: '1',
            type: 'dir',
            children: [
                {
                    name: '1-1',
                    children: [
                        {
                            name: '1-1-1',
                        },
                        {
                            name: '1-1-2'
                        }
                    ]
                },
                {
                    name: '1-2',
                    children: [
                        {
                            name: '1-2-1',
                        },
                        {
                            name: '1-2-2'
                        }
                    ]
                },
                {
                    name: '1-3'
                }
            ]
        }
    ]
    cSvg.init(tree)
</script>
</html>