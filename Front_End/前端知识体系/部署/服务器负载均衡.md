# 服务器负载均衡

负载均衡是由多台服务器以对称的方式组成一个服务器集合，每台服务器都具有等价的地位，都可以单独对外供应效力而无须其他服务器的辅助。经过某种负载分管技术，将外部发送来的请求均匀分配到对称结构中的某一台服务器上，而接收到请求的服务器独登时回应客户的央求。均衡负载可以平均分配客户请求到服务器列阵，借此供应快速获取重要数据，解决很多并发访问效力问题。这种群集技术可以用最少的出资取得接近于大型主机的性能

## 负载均衡原理

系统的扩展可分为纵向（垂直）扩展和横向（水平）扩展。纵向扩展，是从单机的角度通过增加硬件处理能力，比如CPU处理能力，内存容量，磁盘等方面，实现服务器处理能力的提升，不能满足大型分布式系统（网站），大流量，高并发，海量数据的问题。因此需要采用横向扩展的方式，通过添加机器来满足大型网站服务的处理能力。比如：一台机器不能满足，则增加两台或者多台机器，共同承担访问压力。这就是典型的集群和负载均衡架构：如下图：

![](https://ask.qcloudimg.com/http-save/yehe-5941803/er6yp7l2um.jpeg?imageView2/2/w/1620)

## 负载均衡的类型：

**根据DNS的负载均衡**

即一个域名对应多个IP，不同的客户机在DNS服务器中，解析不同的服务器地址，从而达到负载均衡的目的

**反向代理负载均衡**

运用代理服务器可以将请求转发给内部的Web服务器，让代理服务器将请求均匀地转发给多台内部Web服务器之一上，然后达到负载均衡的目的。这种代理方式与一般的代理方式有所不同，标准代理方式是客户运用代理访问多个外部Web服务器，而这种代理方式是多个客户运用它访问内部Web服务器，因此也被称为反向署理模式。

**据NAT的负载均衡技术**

网络地址变换为在内部地址和外部地址之间进行变换，以便具备内部地址的计算机能访问外部网络，而当外部网络中的计算机访问地址变换网关拥有的某一外部地址时，地址变换网关能将其转发到一个映射的内部地址上。因此如果地址变换网关能将每个衔接均匀变换为不同的内部服务器地址，尔后外部网络中的计算机就各自与自己变换得到的地址上服务器进行通讯，然后达到负载分管的目的。

## 二层负载均衡

负载均衡服务器对外依然提供一个VIP（虚IP），集群中不同的机器采用相同IP地址，但是机器的MAC地址不一样。当负载均衡服务器接受到请求之后，通过改写报文的目标MAC地址的方式将请求转发到目标机器实现负载均衡

## 三层负载均衡

和二层负载均衡类似，负载均衡服务器对外依然提供一个VIP（虚IP），但是集群中不同的机器采用不同的IP地址。当负载均衡服务器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器

## 四层负载均衡

四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP/UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器

## 七层负载均衡

七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡

## 四层负载均衡与七层负载均衡区别

- 四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高

- 七层负载均衡更贴近于服务，如:http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的

- 四层负载均衡不识别域名，七层负载均衡识别域名

**Nginx负载均衡配置场景**

Nginx要实现负载均衡需要用到`proxy_pass`代理模块配置

[四层、七层负载均衡的区别](https://cloud.tencent.com/developer/article/1082047)

[Nginx七层负载均衡](https://zhuanlan.zhihu.com/p/83288342)

[大神口中的服务器负载均衡到底是什么意思？](https://cloud.tencent.com/developer/article/1480179)

